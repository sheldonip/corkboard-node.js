<!DOCTYPE html>
<html>
	<head>
		<title>Cork board - Post Message</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="/css/reset.css" rel="stylesheet">
        <!-- Bootstrap -->
        <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="/css/corkboard.css" rel="stylesheet">
        <link href="/css/sketch.css" rel="stylesheet" media="screen">

		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		<script src="../../assets/js/html5shiv.js"></script>
		<script src="../../assets/js/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
	    <div id="wrapper" class="col-lg-12">
	    
        <h1>Post Message</h1>
		<div class="imgholder">
			<button type="button" id="uploadImgBtn" class="btn btn-primary btn-lg">
				Image
				<span class="glyphicon glyphicon-camera"></span>
			</button>
			<button type="button" id="uploadVideoBtn" class="btn btn-success btn-lg">
				Video
				<span class="glyphicon glyphicon-facetime-video"></span>
			</button>
			<button class="btn btn-info btn-lg" data-toggle="modal" data-target="#sketchModal">
				Sketch
				<span class="glyphicon glyphicon-picture"></span>
			</button>
			<button id="btn-youtube" class="btn btn-danger btn-lg" data-toggle="modal" data-target="#youtubeModal">Youtube</button>
			
			<!-- ***TO-DO: Handle multiple images -->
			<form id="galleryForm-1" class="galleryForm" action="" method="POST" enctype="multipart/form-data">
				<input type="file" id="messageImg" name="messageImg" accept="image/*" pattern="([^\s]+(?=\.(jpg|gif|png))\.\2)"/>
				<!-- <input type="hidden" name="?php echo $this -> security -> get_csrf_token_name(); ?>" value="?php echo $this -> security -> get_csrf_hash(); ?>"> -->
			</form>
			
			<form role="form" class="videoForm" action="" method="POST" enctype="multipart/form-data">
				<input type="file" id="messageVideo" name="messageVideo" accept="video/*" pattern="([^\s]+(?=\.(mov|mpeg|mp4|avi|3gp))\.\2)" />
				<!-- <input type="hidden" name="?php echo $this -> security -> get_csrf_token_name(); ?>" value="?php echo $this -> security -> get_csrf_hash(); ?>"> -->
			</form>
			
			<div class="progress" id="my-progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;"></div>
            </div>
		</div>
		
		<form id="msgForm" action="/index.php/message/update" role="form" method="post" accept-charset="utf-8">
			<div class="form-group">
				<textarea class="form-control" id="textContent" name="content" rows="3" required></textarea>
			</div>
			<div class="content-container">
                <ul class="table" id="imgList"></ul>
                <ul class="videoList table">
					<li id="youtube"></li>
				</ul>
            </div>
            <div class="form-group">
            	<label for="type">Current Type:</label>
            	<select class="form-control" name="type" id="type">
					<option value="1" selected>Text</option>
  					<option value="3">Photos</option>
  					<option value="5">Video</option>
  					<option value="6">Sketch</option>
  					<option value="4">Youtube</option>
				</select>
            </div>
			<input type="hidden" name="id" id="" value="<?php echo (int)$messageId; ?>" />
			<input type="hidden" name="videoId" id="videoId" value="" />
			<input type="hidden" name="imagesName" id="imagesName" value="" />
			<input type="hidden" name="notepaperId" id="notepaperId" value="" />
			<input type="hidden" name="messageId" id="messageId" value="" />
			<!-- <input type="hidden" name="?php echo $this -> security -> get_csrf_token_name(); ?>" value="?php echo $this -> security -> get_csrf_hash(); ?>" /> -->
		</form>
		
		<!--
		<button type="button" id="saveBtn" class="btn btn-default btn-lg">
			Save
		</button>
		-->
		
		<button type="button" id="positionBtn" class="btn btn-default btn-lg" data-toggle="modal" data-target="#positionModal">
			Change Notepaper
		</button>
		
        </div>
        
        
        <div class="modal fade" id="youtubeModal" tabindex="-1" role="dialog" aria-labelledby="youtubeModalLabel" aria-hidden="true">
  			<div class="modal-dialog">
    			<div class="modal-content">
      				<div class="modal-header">
      					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        				<h4 class="modal-title" id="myModalLabel">Youtube</h4>
      				</div>
      				<div class="modal-body">
        				<input type="text" class="form-control" name="youtubeUrl" id="youtubeUrl" placeholder="Paste the youtube url" />
      					<div class="youtubeHolder"></div>
      				</div>
      				<div class="modal-footer">
        				<button type="button" id="save-youtube" data-dismiss="modal" class="btn btn-primary">Save changes</button>
      				</div>
    			</div><!-- /.modal-content -->
  			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
        
        
        <div class="modal fade" id="sketchModal" tabindex="-1" role="dialog" aria-labelledby="sketchModalLabel" aria-hidden="true">
  			<div class="modal-dialog">
    			<div class="modal-content">
      				<div class="modal-header">
      					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        				<h4 class="modal-title" id="myModalLabel">Sketch</h4>
      				</div>
      				<div class="modal-body" id="canvas-holder">
        					<div class="tools">
        					</div>
							<canvas id="sketchpad" width="270" height="296">
							</canvas>
						
      				</div>
      				<div id="canvas-footer" class="modal-footer">
      					<button type="button" id="clear-sketch" class="btn btn-default" data-dismiss="">Clear</button>
        				<button type="button" id="save-sketch" data-dismiss="modal" class="btn btn-primary">Save changes</button>
      				</div>
    			</div><!-- /.modal-content -->
  			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<div class="modal fade" id="positionModal" tabindex="-1" role="dialog" aria-labelledby="positionModalLabel" aria-hidden="true">
  			<div class="modal-dialog">
    			<div class="modal-content">
      				<div class="modal-header">
      					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        				<h4 class="modal-title" id="myModalLabel">Choose position</h4>
      				</div>
      				<div class="modal-body" id="canvas-holder">
						<div>
							<div class="note-thumb" position="1"></div>
							<div class="note-thumb" position="2"></div>
							<div class="note-thumb" position="3"></div>
							<div class="note-thumb" position="4"></div>
							<div class="note-thumb" position="5"></div>
							<div class="note-thumb" position="6"></div>
							<div class="note-thumb" position="7"></div>
							<div class="note-thumb" position="8"></div>
						</div>
					</div>
      				<div id="canvas-footer" class="modal-footer">
      					<button type="button" id="clear-sketch" class="btn btn-default" data-dismiss="">Clear</button>
        				<button type="button" id="save-sketch" data-dismiss="modal" class="btn btn-primary">Save changes</button>
      				</div>
    			</div><!-- /.modal-content -->
  			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
        
		<a href='#sketchpad' data-clear='true' id="real-clear-canvas">Clear</a>
		
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="/js/jquery-1.10.2.js"></script>
		<!-- For upload form of photo gallery -->
		<script src="/js/jquery.form.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="/js/bootstrap.min.js"></script>		
		
		<!-- Socket.io -->
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		
		<!-- Custom js -->
		<script src="/js/sketch.js"></script>	
		<script src="/js/baseurl.js"></script>
		<script src="/js/client_ws.js"></script>

		<script>
		
		$( document ).ready(function() {
			Create.initialize(base_url);
			// Initialise forms
			$('form#galleryForm-1').attr('action', base_url+'upload/uploadGallery');
			$('form.videoForm').attr('action', base_url+'upload/uploadVideo');
			
			//Fetch all the data from the local storage
			var uploadedImg = JSON.parse(localStorage.getItem('uploads'));
			var text = localStorage.getItem('text');
			var type = localStorage.getItem('type');
			var notepaperId = localStorage.getItem('notepaperId');
			
			var imgList = $('#imgList');
			if(uploadedImg != null && uploadedImg.imageName){
				var uploadedImgLength = uploadedImg.imageName.length;
				for(var i=0; i < uploadedImgLength; i++){
					imgList.append('<li class="image"><a class="removeThumbnail" href="#">&times;</a><div class="uThumbnail" style="background-image: url('+ base_url +'uploads/thumbnail/'+ uploadedImg.imageName[i] +');"></div><input type="hidden" name="url[]" class="imgUrl" value="'+uploadedImg.imageName[i]+'" /></li>');
				}
			}
			if(text!=null){
				$('#textContent').val(text);
			}
			if(type!=null){
				$('#type').val(type);
			}
		});
			
						
			//customize upload button
			$('#uploadImgBtn').click(function(){
        		// Simulate a click on the file input button
        		// to show the file browser dialog
       			$('#messageImg').click();
    		});
    		
    		$('#uploadVideoBtn').click(function(){
        		// Simulate a click on the file input button
        		// to show the file browser dialog
       			$('#messageVideo').click();
    		});

			//automatic upload after choosing the file
			$( "#messageImg" ).on("change", function() {
				$(this).parent().submit();
			});
			$( "#messageVideo" ).on("change", function() {
				$(this).parent().submit();
			});
			
		// Upload text messages
	$('#textContent').keyup(function(evt) {	
		// url check
		var string = $(this).val();
		var youtubematch = string.match(/((http:\/\/)|(https:\/\/)){0,1}(www\.){0,1}(youtube\.com)\/[^\s]+/g);
		var youtubematch1 = string.match(/((http:\/\/)|(https:\/\/)){0,1}(www\.){0,1}(youtu\.be)\/[^\s]+/g);
		var holder = $("div.content-container ul.videoList li#youtube");
		var idField = $('#videoId');
		var a = $('<a>', { href:youtubematch1 } )[0];
		var videoId;
		var uploads = JSON.parse(localStorage.getItem('uploads'));
		
		if(youtubematch1!=null){
			videoId = a.pathname.slice(1);
		} else if(youtubematch!=null) {
			videoId = getParameterByName('v',youtubematch);
		} else {}
		
		console.log('[DEBUG] videoId: ' + videoId);
		
		//if the input url is a valid youtube url and it is the first time for it to appear
		if((youtubematch!=null || youtubematch1!=null)){
			holder.empty();	
			if(!videoId){
				return false; 
			}
			$.ajax({
 				url: 'http://gdata.youtube.com/feeds/api/videos/'+videoId,
				type: "GET",
				data: { v: "2", alt: "jsonc"},
				dataType: "jsonp",
				success: function(youtube) {
					if(youtube.status=="error"){
						alert(youtube.msg);
					} else { 
						var uploads = JSON.parse(localStorage.getItem('uploads')) || {};
						holder.empty();	
						if(youtube.data){
							holder.append('<button class="btn btn-link removeYoutube">&times;</button>');
							holder.append('<div class="thumbnailHolder"><img class="youtubeThumbnail" src="'+ youtube.data.thumbnail.sqDefault +'" /></div>');
							holder.append('<div class="youtubeTitle"><h5><a target="_blank" href="http://www.youtube.com/watch?v='+ youtube.data.id +'">' + youtube.data.title + '</a></h5></div>');
							holder.append('<div class="youtubeDescription">'+youtube.data.description.substr(0, 125)+'</div>');
							holder.append('</li>');
							// Update UI
							$('form div.content-container ul.videoList > li').css('padding','2%');
							$('form div.content-container ul.videoList > li').css('border','1px solid #CCCCCC');
							
							idField.attr('value', youtube.data.id);
							//$('#textTitle').attr('value', data.title);
							
							uploads.videoId = videoId;
							localStorage.setItem('uploads', JSON.stringify(uploads));
							$('#type').val("4");
							Create.updateMsg();
						}
						
					}
				},
  
				error: function() {
					alert("ERROR!!!");
				}
			});
			
		}
		// end of url check
		
		// Check any uploads still stored in localstorage
		if(uploads.imageName && uploads.imageName.length > 0){
			$('#type').val("3");
		} else if (uploads.videoName && uploads.videoName.length > 0){
			$('#type').val("5");
		} else if (uploads.videoId && uploads.videoId.length > 0){
			$('#type').val("4");
		} else {
			$('#type').val("1");
		}
	
		Create.updateMsg();
		return false;
	});		
			
			
			//upload the image of gallery  	
  	$('body').on('submit', '.galleryForm', function(evt) {  	
		console.log('[DEBUG] .galleryForm submitting...');
  		evt.preventDefault();
  		var galleryForm = $(this);
  		var imgList = $('#imgList');
  		var filename = $(this).children('#messageImg').val().split('/').pop().split('\\').pop();
  		var progressBar = $('#my-progress').children('.progress-bar');
                 $(this).ajaxSubmit({                 	
                    beforeSend: function() {
                    	$('#my-progress').show();
                        var progress = '0%';
                        progressBar.css(
							'width',
							progress
							);
                    },
                    uploadProgress: function(event, position, total, percentComplete) {
                        var progress = percentComplete + '%';
                        progressBar.css(
						'width',
						progress
						);
                    },
                    complete: function(xhr) {
                     	galleryForm.clearForm();
                     	progressBar.width('0%');
                     	var data = JSON.parse(xhr.responseText);
						var uploadedImg = JSON.parse(localStorage.getItem('uploads'));
                     	if(data.status=="error"){
                         	alert(data.status);
                        }else{
							imgList.append('<li class="image"><a class="removeThumbnail" href="#">&times;</a><div class="uThumbnail" style="background-image: url('+ base_url +'uploads/thumbnail/'+ data.imageName +');"></div><input type="hidden" name="url[]" class="imgUrl" value="'+data.imageName+'" /></li>');
							
							
                            $('#type').val("3");
                            $('#my-progress').hide();
							
							//If the user has not uploaded any picture yet, create a local storage to store the names of the uploaded image
							if(uploadedImg == null || uploadedImg.imageName == null){
								uploadedImg = {};
								uploadedImg.imageName = [];
								uploadedImg.imageName[0] = data.imageName;
							}
							else{ //append the newly uploaded image to the local storage
								uploadedImg.imageName.push(data.imageName);
							}
							localStorage.setItem('uploads', JSON.stringify(uploadedImg));
							Create.updateMsg();
                        }
                         	
                    }
					
                 });
    });
    
    
    //upload the video
    $('body').on('submit', '.videoForm', function(evt) {
				evt.preventDefault();				
				var videoForm = $(this);
				//var videoHolder = $(this).parent();
				//var urlField = $(this).parent().next('.gridVideoForm').children('[name="url"]');
				var videoList = $('.videoList');
				var progressBar = $('#my-progress').children('.progress-bar');
				$(this).ajaxSubmit({
						beforeSend: function() {
							$('#my-progress').show();
							var progress = '0%';
							progressBar.css('width',progress);
						},
						uploadProgress: function(event, position, total, percentComplete) {
							var progress = percentComplete + '%';
							progressBar.css('width',progress);
						},
						complete: function(xhr) {
							var data = JSON.parse(xhr.responseText);
							var uploadedVideo = JSON.parse(localStorage.getItem('uploads'));
							videoForm.clearForm();
							progressBar.width('0%');
							if(data.status=="error"){
								console.log(data.msg);
							}else{
								videoList.append('<li class="image"><div class="removeThumbnail">&times;</div><div class="uThumbnail" style="background-image: url(' +base_url+'uploads/video/'+ data.thumbnail +');"></div><input type="hidden" name="videoUrl" class="videoUrl" value="'+data.msg+'" /></li>');
								$('#type').val("5");
								$('#my-progress').hide();
								$('#uploadVideoBtn').hide();
								
								//If the user has not uploaded any picture yet, create a local storage to store the names of the uploaded image
								if(uploadedVideo == null || uploadedVideo.videoName == null){
									uploadedVideo = {};
									uploadedVideo.videoName = [];
									uploadedVideo.videoName[0] = data.msg;
								}
								else{ //append the newly uploaded image to the local storage
									uploadedVideo.videoName.push(data.msg);
								}
								localStorage.setItem('uploads', JSON.stringify(uploadedVideo));
								
								//Boardcast update
								Create.updateMsg();
								//$('#msgForm').submit();
							}
						}
				});
				return false;
			});
    
    //remove the uploaded image of photo gallery
    $('body').on('click', '#imgList .removeThumbnail', function(evt) {

    		$(this).parent().remove();
			var uploadedImg = JSON.parse(localStorage.getItem('uploads'));
    		var uploadedImgLength = uploadedImg.imageName.length;
			for(var i=0; i < uploadedImgLength; i++){
				if(uploadedImg.imageName[i] == $(this).parent().find('.imgUrl').attr('value')){
					uploadedImg.imageName.splice(i, 1);
					localStorage.setItem('uploads', JSON.stringify(uploadedImg));
					
				}	
			}
			
    		if($('#imgList .removeThumbnail')){
				$('#type').val("1");
				Create.updateMsg();
			}
    	
   	});   	
   	
	//remove the thumbnail of uploaded video
	$('body').on('click', '.videoList .removeThumbnail', function(evt) {
    		$(this).parent().remove();
			
			var uploadedVideo = JSON.parse(localStorage.getItem('uploads'));
    		var uploadedVideoLength = uploadedVideo.videoName.length;
			for(var i=0; i < uploadedVideoLength; i++){
				if(uploadedVideo.videoName[i] == $(this).parent().find('.videoUrl').attr('value')){
					uploadedVideo.videoName.splice(i, 1);
					localStorage.setItem('uploads', JSON.stringify(uploadedVideo));
					
				}	
			}
			
    		//$('#msgForm').submit();
			$('#type').val("1");
			Create.updateMsg();
    		console.log("remove.");
    		$('#uploadVideoBtn').show();
    	
   	});   
   	
   	//Paste Youtube URL
   	/*$('body').on('change', '#youtubeUrl', function(evt) {
    	var site= $(this).val();
		var match = site.match(/^((http:\/\/)|(https:\/\/)){0,1}(www\.){0,1}(youtube\.com)/g);
		var match1 = site.match(/^((http:\/\/)|(https:\/\/)){0,1}(www\.){0,1}(youtu\.be)/g);
		var holder = $(this).next();
		var idField = $('#videoId');
		var a = $('<a>', { href:site } )[0];
		var videoId;
		var uploads = JSON.parse(localStorage.getItem('uploads'));
		
		if(match1!=null){
			videoId = a.pathname.slice(1);
		} else {
			videoId = getParameterByName('v',site);
		}
		console.log('[DEBUG] videoId: ' + videoId);
		
		//if the input url is a valid youtube url and it is the first time for it to appear
		if((match!=null || match1!=null)){
			holder.empty();	
			$.ajax({
 				url: 'http://gdata.youtube.com/feeds/api/videos/'+videoId,
				type: "GET",
				data: { v: "2", alt: "jsonc"},
				dataType: "jsonp",
				success: function(youtube) {
					if(youtube.status=="error"){
						alert(youtube.msg);
					} else { 
						var uploads = JSON.parse(localStorage.getItem('uploads')) || {};
						holder.append('<button class="btn btn-link removeYoutube">&times;</button>');
						holder.append('<div class="thumbnailHolder"><img class="youtubeThumbnail" src="'+ youtube.data.thumbnail.sqDefault +'" /></div>');
						holder.append('<div class="youtubeTitle"><h5><a target="_blank" href="http://www.youtube.com/watch?v='+ youtube.data.id +'">' + youtube.data.title + '</a></h5></div>');
						holder.append('<div class="youtubeDescription">'+youtube.data.description.substr(0, 125)+'</div>');
						// Update UI
                        $('div.youtubeHolder').css('padding','2%');
                        $('div.youtubeHolder').css('border','1px solid #CCCCCC');
						
						idField.attr('value', youtube.data.id);
						//$('#textTitle').attr('value', data.title);
						
						uploads.videoId = videoId;
						localStorage.setItem('uploads', JSON.stringify(uploads));
						$('#type').val("4");
						Create.updateMsg();
						
					}
				},
  
				error: function() {
					alert("ERROR!!!");
				}
			});
			
		}
	});*/
	
	//remove the youtube holder
	$('body').on('click', '.removeYoutube', function(evt) {
		evt.preventDefault();
		var uploadedVideo = JSON.parse(localStorage.getItem('uploads'));
    	var uploadedVideoLength = uploadedVideo.videoId.length;
		if(uploadedVideoLength > 0){
			uploadedVideo.videoId = [];
			localStorage.setItem('uploads', JSON.stringify(uploadedVideo));
		}
	
	    // Update UI
	    $('form div.content-container ul.videoList > li').css('padding','0%');
	    $('form div.content-container ul.videoList > li').css('border','0');
    	$(this).parent().children().remove();
   	});
   	
   	//submit after save youtube url
   	$("#save-youtube").on("click", function() {
		$('#type').val("4");
		Create.updateMsg();
		//$('#msgForm').submit();
	});
	
	//sketchpad
	$(function() {
    	$.each(['#f00', '#ff0', '#0f0', '#0ff', '#00f', '#f0f', '#000', '#fff'], function() {
    		$('#canvas-holder .tools').append("<a href='#sketchpad' data-color='" + this + "' style='width: 30px; background: " + this + ";'></a> ");
    	});
    	$('#sketchpad').sketch();
  	});
  	
  	$("#save-sketch").on("click", function(event ) {
				event.preventDefault();
				var canvasTest = document.getElementById('sketchpad');
				var canvasData = canvasTest.toDataURL("image/png");
				var imgList = $('#imgList');
				var text = $('#textContent').val();
				
				
				$.ajax({
					type : "POST",
					url : base_url+'upload/uploadSketch',
					data : {
						imgData : canvasData//,
						//<?php echo $this -> security -> get_csrf_token_name(); ?> : "<?php echo $this -> security -> get_csrf_hash(); ?>"
					},
					dataType : "json"
				}).done(function(data) {
					var uploadedImg = JSON.parse(localStorage.getItem('uploads'));
					imgList.append('<li class="image"><a class="removeThumbnail" href="#">&times;</a><div class="uThumbnail" style="background-image: url('+ base_url +'uploads/thumbnail/'+ data.imageName +');"></div><input type="hidden" name="url[]" class="imgUrl" value="'+data.imageName+'" /></li>');
					$('#type').val("3");
					canvasData = "";
						//If the user has not uploaded any picture yet, create a local storage to store the names of the uploaded image
							if(uploadedImg == null){
								uploadedImg = {};
								uploadedImg.imageName = [];
								uploadedImg.imageName[0] = data.imageName;
							}
							else{ //append the newly uploaded image to the local storage
								uploadedImg.imageName.push(data.imageName);
							}
							localStorage.setItem('uploads', JSON.stringify(uploadedImg));
							Create.updateMsg();

				});
	});
	
	$("#clear-sketch").on("click", function(event ) {
		event.preventDefault();
		$('#real-clear-canvas').click();
		var canvas = document.getElementById('sketchpad');
		var context = canvas.getContext('2d');
		context.clearRect(0,0,270,296);
		//sketch.clear();
	});
	
	// Get parameter by name in a url string
	function getParameterByName(name, string){
	  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	  var regexS = "[\\?&]"+name+"=([^&#]*)";
	  var regex = new RegExp( regexS );
	  var results = regex.exec(string);
	  if( results == null )
		return "";
	  else
		return decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	
	$("#positionBtn").on("click", function(){
		// Check unoccupied notepapers and show results
		//console.log('[DEBUG] queryPositions()');
		 Create.queryPositions();
	});


	</script>

	</body>
</html>